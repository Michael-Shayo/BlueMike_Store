{% extends "base.html" %}
{% load static %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
  {% if user.is_authenticated %}
    <div class="profile-container">
      <hr>
        <h2>My Profile</h2>
        <hr>
        {% if messages %}
          {% for message in messages %}
            <div class="alert {{ message.tags }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
        <div class="profile-card">
            <div class="profile-avatar">
                {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" alt="{{ user.username|capfirst }}">
                {% else %}
                    <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar">
                {% endif %}
            </div>
            <h3 class="profile-title">{{ request.user.username|capfirst }}</h3>
            <details>
                <summary>Update Profile</summary>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>Profile Image</label>
                        <input type="file" name="avatar" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address" value="{{ profile.address }}" placeholder="Enter your address">
                    </div>
                    <button type="submit" class="btn-primary ">Save Profile</button>
                </form>
                {% if user.is_authenticated and user.is_seller %}
                {% comment %} <a href="{% url 'bluesoko:apply_shop' %}"><button class="btn-primary apply">Apply Shop</button></a> {% endcomment %}
                    {% if user_shop %}
                      <a href="{% url 'bluesoko:seller_dashboard' %}">
                        <button class="btn-primary apply">üè™ View Shop Dashboard</button>
                      </a>
                    {% else %}
                      <a href="{% url 'bluesoko:apply_shop' %}">
                        <button class="btn-primary apply">‚ûï Apply for Shop</button>
                      </a>
                    {% endif %}
                {% else %}
                {% endif %}
            </details>
            <br><br> 
            <h4>Profile Info</h4>
            <hr>
            <p><b>Username:</b> {{ user.username|capfirst }}</p>
            <div style="display: flex; justify-content: center; gap: 1rem;">
              <p><b>Role:</b> {{ user.get_role_display }}</p>
              <p><b>Status:</b> {{ user.get_status_display }}</p>  
            </div>
            <p><b>Address:</b> {{ profile.address|default:"‚Äî" }}</p>
            <h4>Contacts</h4>
            <p><b>Email:</b> {{ user.email }}</p>
            <p><b>Phone:</b> {{ user.phone|default:"‚Äî" }}</p>
        </div>


      {% if seller_profile %}
        <div class="profile-card">
          {% comment %} <h4>Seller Information</h4> {% endcomment %}
          <h4>Business Information</h4>
          <hr>
          <p><b>Business Name:</b> {{ seller_profile.business_name|capfirst }}</p>
          <p><b>Email:</b> {{ seller_profile.business_email }}</p>
          <p><b>Region:</b> {{ seller_profile.get_region_display }}</p>
        </div>
      {% endif %}
    </div>
    
    {% if seller_profile and seller_profile.shop_location %}
      <div class="profile-card">
          <h4>üìç Shop Location</h4>
          <div id="map" style="height: 300px; border-radius: 12px;"></div>
      </div>

      <script>
          const lat = {{ seller_profile.shop_location.latitude }};
          const lng = {{ seller_profile.shop_location.longitude }};
          const map = L.map('map').setView([lat, lng], 15);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          L.marker([lat, lng])
              .addTo(map)
              .bindPopup("<b>{{ seller_profile.business_name }}</b>")
              .openPopup();
      </script>
    {% endif %}

  {% else %}
  <h2>No any Profile for the guest user</h2>
  {% endif %}
{% endblock %}

